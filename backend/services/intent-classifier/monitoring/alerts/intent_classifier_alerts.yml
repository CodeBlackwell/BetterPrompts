groups:
  - name: intent_classifier_alerts
    interval: 30s
    rules:
      # Service availability
      - alert: IntentClassifierDown
        expr: up{job="intent-classifier"} == 0
        for: 2m
        labels:
          severity: critical
          service: intent-classifier
        annotations:
          summary: "Intent Classifier service is down"
          description: "Intent Classifier service has been down for more than 2 minutes"

      # High error rate
      - alert: IntentClassifierHighErrorRate
        expr: |
          (
            sum(rate(intent_classification_requests_total{status=~".*error.*"}[5m]))
            /
            sum(rate(intent_classification_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "High error rate in Intent Classifier"
          description: "Error rate is above 5% for the last 5 minutes (current: {{ $value | humanizePercentage }})"

      # High latency
      - alert: IntentClassifierHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(intent_classification_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "High latency in Intent Classifier"
          description: "95th percentile latency is above 500ms for the last 5 minutes (current: {{ $value | humanizeDuration }})"

      # Model health
      - alert: IntentClassifierModelUnhealthy
        expr: |
          sum(intent_classifier_model_health{status="unhealthy"}) > 0
        for: 2m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "One or more models are unhealthy"
          description: "Model {{ $labels.model }} is reporting unhealthy status"

      # TorchServe connection issues
      - alert: TorchServeConnectionError
        expr: |
          sum(rate(intent_classification_requests_total{status="torchserve_connection_error"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "TorchServe connection errors"
          description: "Experiencing TorchServe connection errors ({{ $value | humanize }} errors/sec)"

      # Cache hit rate too low
      - alert: IntentClassifierLowCacheHitRate
        expr: |
          (
            sum(rate(intent_classification_requests_total{status="cache_hit"}[10m]))
            /
            sum(rate(intent_classification_requests_total[10m]))
          ) < 0.3
        for: 10m
        labels:
          severity: info
          service: intent-classifier
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is below 30% for the last 10 minutes (current: {{ $value | humanizePercentage }})"

      # High memory usage
      - alert: IntentClassifierHighMemoryUsage
        expr: |
          (
            container_memory_usage_bytes{name="intent-classifier-prod"}
            /
            container_spec_memory_limit_bytes{name="intent-classifier-prod"}
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "High memory usage in Intent Classifier"
          description: "Memory usage is above 80% of limit (current: {{ $value | humanizePercentage }})"

      # Model routing imbalance
      - alert: ModelRoutingImbalance
        expr: |
          (
            stddev(sum by (model) (rate(model_selection_total[10m])))
            /
            avg(sum by (model) (rate(model_selection_total[10m])))
          ) > 2
        for: 10m
        labels:
          severity: info
          service: intent-classifier
        annotations:
          summary: "Model routing imbalance detected"
          description: "Significant imbalance in model selection distribution"

      # Feature flag issues
      - alert: FeatureFlagConfigurationError
        expr: |
          sum(rate(feature_flag_errors_total[5m])) > 0
        for: 2m
        labels:
          severity: warning
          service: intent-classifier
        annotations:
          summary: "Feature flag configuration errors"
          description: "Errors in feature flag system ({{ $value | humanize }} errors/sec)"